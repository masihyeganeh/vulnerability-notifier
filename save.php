<?php

include 'webservice.php';

$technologies = getTechnologies(@$_GET['address'], array_key_exists('exactDomain', $_GET), array_key_exists('includingSubPages', $_GET));

function prepareForInsert($value='', $secondValue=null)
{
	if ($secondValue === null)
		return '("' . $value . '")';
	return '("' . $secondValue . '", "' . $value . '")';
}

$address = @$_GET['address'];
$email = @$_GET['email'];

$mysqli = new mysqli(DatabaseHostName, DatabaseUserName, DatabasePassword, DatabaseName);
if ($mysqli->connect_errno) {
    echo json_encode('Failed to connect to MySQL: (' . $mysqli->connect_errno . ') ' . $mysqli->connect_error);
}

if ($result = $mysqli->query('SELECT id FROM sites WHERE address = "' . $mysqli->real_escape_string($address) . '";'))
{
	if ($result->num_rows)
	{
		$row = $result->fetch_object();
		$id = $row->id;
		$result->close();
		$mysqli->query('DELETE FROM site_technologies WHERE site_id = ' . $id);
		$mysqli->query('DELETE FROM sites WHERE id = ' . $id);
	}
}

$mysqli->query('INSERT INTO sites (`address`, `email`) VALUES ("' . $mysqli->real_escape_string($address) . '", "' . $mysqli->real_escape_string($email) . '");');

$siteId = $mysqli->insert_id;

if (count($technologies))
{
	$mysqli->query('INSERT IGNORE INTO technologies (`name`) VALUES ' . implode(', ', array_map('prepareForInsert', $technologies)));

	if ($result = $mysqli->query('SELECT id FROM technologies WHERE name IN ("' . implode('", "', $technologies) . '");'))
	{
		if ($result->num_rows)
		{
			$ids = array();

			$rows = $result->fetch_all(MYSQLI_ASSOC);
			$result->close();
			for ($i=0; $i < count($rows); $i++) { 
				array_push($ids, $rows[$i]['id']);
			}

			$mysqli->query('INSERT INTO site_technologies (`site_id`, `technology_id`) VALUES ' . implode(', ', array_map('prepareForInsert', $ids, array_fill(0, count($ids), $siteId))));

			echo json_encode('Done. wait for our notifications');
		}
	}
}
