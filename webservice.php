<?php

require_once('config.php');


function getJson($url)
{
	$cURL = curl_init($url);
	curl_setopt($cURL, CURLOPT_RETURNTRANSFER, true);
	$json = curl_exec($cURL);
	curl_close($cURL);
	return json_decode($json);
}

function getEmails($address)
{
	$url = 'http://api.builtwith.com/v7/api.json?KEY=' . BuiltWithDomainAPIKey . '&HIDETEXT=yes&LOOKUP=' . urlencode($address);

	$json = getJson($url);

	if (count($json->Errors))
		throw new Exception($json->Errors);

	$emails = array();

	$people = $json->Results[0]->Meta->Names;
	if ($people)
	{
		foreach ($people as $person)
		{
			array_push($emails, $person->Email);
		}
	}

	return array_unique($emails);
}

function getTechnologies($address, $exactDomain=false, $includingSubPages=true)
{
	$url = 'http://api.builtwith.com/v7/api.json?KEY=' . BuiltWithDomainAPIKey . '&HIDETEXT=yes&LOOKUP=' . urlencode($address);

	$json = getJson($url);

	if (count($json->Errors))
		throw new Exception($json->Errors);

	$technologies = array();

	foreach ($json->Results[0]->Result->Paths as $result)
	{
		if ($result->Url == 'dd' && $includingSubPages === false) continue;

		$url = $result->SubDomain;
		if ($result->SubDomain)
			$url = $result->SubDomain . '.' . $url;

		if ($url != $address && $exactDomain === true) continue;

		foreach ($result->Technologies as $technology)
		{
			array_push($technologies, $technology->Name);
		}
	}

	return array_unique($technologies);
}

function getVulnerableThechnologies($technologies)
{
	$url = 'http://www.cvedetails.com/json-feed.php?numrows=30&vendor_id=0&product_id=0&version_id=0&hasexp=1&opec=1&opov=1&opcsrf=1&opfileinc=1&opgpriv=1&opsqli=1&opxss=1&opdirt=1&opmemc=1&ophttprs=1&opbyp=1&opginf=1&opdos=1&orderby=3&cvssscoremin=0';
	$vulnerableThechnologies = array();

	$json = getJson($url);

	foreach ($json as $cve)
	{
		$remainingTechnologies = array();
		foreach ($technologies as $technology)
		{
			if (stripos($cve->summary, $technology))
			{
				$vulnerableThechnologies[$technology] = $cve->url;
			}
			else
				array_push($remainingTechnologies, $technology);
		}

		$technologies = $remainingTechnologies;
	}

	return $vulnerableThechnologies;
}
