<?php

include 'webservice.php';

function notifyVulnerability($email, $website, $technology, $cveLink)
{
	$message = 'This email will be sent to: ' . $email  . '<br>We are notifying you about a new vulnerability found for ' . $technology . ' used on ' . $website . '. More details: ' . $cveLink;
	echo $message . '<br><br>';

	mail($email, 'New vulnerability found for ' . $website, $message);
}

$mysqli = new mysqli(DatabaseHostName, DatabaseUserName, DatabasePassword, DatabaseName);
if ($mysqli->connect_errno) {
    echo 'Failed to connect to MySQL: (' . $mysqli->connect_errno . ') ' . $mysqli->connect_error;
}

$technologies = array();

if ($result = $mysqli->query('SELECT * FROM technologies;'))
{
	if ($result->num_rows)
	{
		$ids = array();

		$rows = $result->fetch_all(MYSQLI_ASSOC);
		$result->close();
		for ($i=0; $i < count($rows); $i++) { 
			$technologies[$rows[$i]['id']] = $rows[$i]['name'];
		}
	}
}

$vulnerableThechnologies = getVulnerableThechnologies($technologies);

$technologies = array_flip($technologies);

foreach ($vulnerableThechnologies as $technology => $link) {
	$technologyId = $technologies[$technology];
	if ($result = $mysqli->query('SELECT address, email FROM sites WHERE id IN (SELECT site_id FROM site_technologies WHERE technology_id = ' . $technologyId . ');'))
	{
		if ($result->num_rows)
		{
			$ids = array();

			$rows = $result->fetch_all(MYSQLI_ASSOC);
			$result->close();

			for ($i=0; $i < count($rows); $i++)
			{
				notifyVulnerability($rows[$i]['email'], $rows[$i]['address'], $technology, $link);
			}
		}
	}
}
